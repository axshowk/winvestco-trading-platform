apiVersion: 1

groups:
  - orgId: 1
    name: Golden Signals Alerts
    folder: Trading Platform
    interval: 1m
    rules:
      # LATENCY ALERT: P99 > 200ms for 2 minutes
      - uid: latency-p99-alert
        title: High P99 Latency
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, service)) > 0.2
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          summary: "P99 latency exceeds 200ms for {{ $labels.service }}"
          description: "Service {{ $labels.service }} has P99 latency of {{ $value | printf \"%.3f\" }}s"
        labels:
          severity: warning

      # ERROR RATE ALERT: > 1% for 2 minutes
      - uid: error-rate-alert
        title: High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (service) / sum(rate(http_server_requests_seconds_count[5m])) by (service)) * 100 > 1
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          summary: "Error rate exceeds 1% for {{ $labels.service }}"
          description: "Service {{ $labels.service }} has {{ $value | printf \"%.2f\" }}% error rate"
        labels:
          severity: critical

      # SERVICE DOWN ALERT
      - uid: service-down-alert
        title: Service Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: up == 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: Alerting
        execErrState: Error
        for: 1m
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "No metrics received from {{ $labels.instance }}"
        labels:
          severity: critical

      # SATURATION ALERT: CPU > 80% for 5 minutes
      - uid: cpu-saturation-alert
        title: High CPU Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: system_cpu_usage * 100 > 80
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "High CPU usage on {{ $labels.service }}"
          description: "CPU at {{ $value | printf \"%.1f\" }}%"
        labels:
          severity: warning

      # SATURATION ALERT: Memory > 90% for 5 minutes
      - uid: memory-saturation-alert
        title: High Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) * 100 > 90
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "High memory usage on {{ $labels.service }}"
          description: "JVM heap at {{ $value | printf \"%.1f\" }}%"
        labels:
          severity: warning
